REM  *****  BASIC  *****

Sub Main

	dim document as object
	dim sheet as object
	dim maxRowNum as integer
	
	rem-- Kullanılan dosyadaki sayfa adı Sheet1 olmalıdır.
	document=ThisComponent
	sheet=document.Sheets.getByIndex(0)
	
	sheet.unprotect("193782")
	
	saveCustomer(sheet)
	if document.isModified then 
		maxRowNum = getMaxRowNum(sheet)
		maxRowNum = removeEmptyCells(sheet, maxRowNum)
		addDateIfNeeded(sheet, maxRowNum)
		arrangeTotalCell(sheet)
	end if
	sheet.protect("193782")

End Sub

function removeEmptyCells(sheet as object, maxRowNum as integer) 
	dim priceCell as object
	for i = 2 to maxRowNum
		priceCell = sheet.getCellByPosition(1, i)
		if Len(priceCell.getString()) = 0 then
			sheet.rows.removeByIndex(i, 1)
			i = i - 1
			maxRowNum = maxRowNum - 1
		end if
	next i
	removeEmptyCells = maxRowNum
end function

function getMaxRowNum(sheet as object)
	dim priceCell as object
	dim dateCell as object
	maxRowNum = 500
	priceCell = sheet.getCellByPosition(1, maxRowNum) 
	dateCell = sheet.getCellByPosition(0, maxRowNum)
	while Len(priceCell.getString()) = 0 and Len(dateCell.getString()) = 0
		maxRowNum = maxRowNum - 1
		dateCell = sheet.getCellByPosition(0, maxRowNum)
		priceCell = sheet.getCellByPosition(1, maxRowNum)
	wend
	getMaxRowNum = maxRowNum
end function

function addDateIfNeeded(sheet as object, maxRowNum as integer)
	dim priceCell as object
	dim dateCell as object
	for i = 2 to maxRowNum
		dateCell = sheet.getCellByPosition(0, i)
		priceCell = sheet.getCellByPosition(1, i)
		if Len(priceCell.getString()) > 0 and Len(dateCell.getString()) = 0 then
			dateCell.setValue(Now())
			priceCell.CellBackColor = RGB(30, 255, 86)
		end if
	next i
end function

function arrangeTotalCell(sheet as object)
	dim totalCell as object
	totalCell = sheet.getCellByPosition(3, 2)
	totalCell.setFormula("=SUM(B2:B9999)")
end function

function saveCustomer(sheet as object)
	dim cell as object
	cell = sheet.getCellByPosition(0, 0)
	if cell.getString() = "MÜŞTERİ ADI" then
		dim customerName as string
		dim filePath as string
		dim saveToUrl as string 
		customerName = InputBox("Müşteri adını giriniz:")
		cell.setString(UCase(customerName))
		filePath = "/home/akin/Masaüstü/"
		saveToUrl = ConvertToURL(filePath & customerName)
		ThisComponent.store()
		rem-- ThisComponent.StoreToUrl(saveToUrl, Array(MakePropertyValue("FilterName", "Calc8")))
	end if
	
end function

Function MakePropertyValue(Optional sName As String, Optional sValue) As com.sun.star.beans.PropertyValue
'-------------------------------------------------------------------
' Create and return a new com.sun.star.beans.PropertyValue
'-------------------------------------------------------------------

    Dim oPropertyValue As New com.sun.star.beans.PropertyValue
    
    
    If Not IsMissing(sName) Then
       oPropertyValue.Name = sName
    EndIf
    
    If Not IsMissing(sValue) Then
       oPropertyValue.Value = sValue
    EndIf
    
    MakePropertyValue() = oPropertyValue

End Function

